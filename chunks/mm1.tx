\section
[$M/M/1$ queue]
{$\mathbf{M/M/1}$ queue}
\label{sec:mm1}


\subsection*{Theory and Exercises}
\label{sec:exercises}

\Opensolutionfile{hint}
\Opensolutionfile{ans}

In the $M/M/1$ queue, one server serves jobs arriving with
exponentially distributed interarrival times and each job requires an
exponentially distributed processing time.  With Eq.~(\ref{eq:25}),
i.e., $\lambda(n)p(n)= \mu(n+1)p(n+1)$ we can derive a number of
important results for this queueing process.

Recall from Section~\ref{sec:queu-proc-as} that we can construct the
$M/M/1$ queue as a reflected random walk where the arrivals are
generated by a Poisson process $N_\lambda(t)$ and the departures
(provided the number in the $L(t)>0$) are generated according to the
Poisson process $N_\mu(t)$. Since the rates of these processes do not
depend on the state of the random walk, or the queue for that matter,
$\lambda(n)=\lambda$ and $\mu(n)=\mu$ for all $n$. Thus, \eqref{eq:25}
reduces to
\begin{equation*}
  p(n+1) = \frac{\lambda(n)}{\mu(n+1)} p(n) = \frac{\lambda}{\mu} p(n) = \rho p(n),
\end{equation*}
where we use the definition of the load $\rho=\lambda/\mu$. Since this
holds for any $n\geq 0$, it follows with recursion that
\begin{equation*}
  p(n+1) = \rho^{n+1} p(0).
\end{equation*}
Then, from the normalization condition
\begin{equation*}
1=  \sum_{n=0}^\infty p(n) = p(0)\sum_{n=0}^\infty \rho^n = \frac{p(0)}{1-\rho},
\end{equation*}
it follows that
\begin{align}\label{eq:23}
p(0) &=1-\rho, &   p(n) &=  (1-\rho)\rho^{n}.
\end{align}

How can we use these equations? First, note that $p(0)$ must be the
fraction of time the server is idle. Hence, the fraction of time the
server is busy, i.e., the utilization, is
\begin{equation*}
  1-p(0) = \rho = \sum_{n=1}^\infty p(n).
\end{equation*}
Here the last equation has the interpretation of the fraction of time
the system contains at least 1 job. 



\begin{exercise}
Show that the average number of jobs in an  $M/M/1$ queue is given by
\begin{equation}\label{eq:el}
  \E L = \frac \rho{1-\rho}.
\end{equation}
  \begin{solution}
\begin{align*}
\E L &= \sum_{n=0}^\infty n p(n) \\
&= \sum_{n=0}^\infty \sum_{i=1}^n \1{i\leq n} p(n)  && n=\sum_{i=1}^n \1{i\leq n}\\
&= \sum_{n=0}^\infty \sum_{i=1}^\infty   \1{i\leq n} p(n)  && i>n\implies \1{i\leq n} = 0\\
&= \sum_{i=1}^\infty \sum_{n=0}^\infty  \1{i\leq n} p(n) &&\text{Fubini} \\
&= \sum_{i=1}^\infty \sum_{n=i}^\infty p(n) && n < i \implies \1{i\leq n}=0 \\
&= \sum_{i=1}^\infty \sum_{n=i}^\infty (1-\rho)\rho^n && p(n) = (1-\rho)\rho^n \\
&= \sum_{i=1}^\infty \sum_{n=0}^\infty (1-\rho)\rho^{n+i} && n\to n+i \\
&= \sum_{i=1}^\infty (1-\rho)\rho^i \sum_{n=0}^\infty \rho^n && \rho^{n+i}=\rho^i \rho^n\\
&= \sum_{i=1}^\infty (1-\rho)\rho^i \frac1{1-\rho}   \\
&= \sum_{i=1}^\infty \rho^i \\
&= \sum_{i=0}^\infty \rho^{i+1} && i\to i+1\\
&= \rho \sum_{i=0}^\infty \rho^i \\
&= \frac{\rho}{1-\rho}.
\end{align*}
Note that, since the summands are positive, we can use Fubini's theorm
to justify the interchange of the summations.

  \end{solution}
\end{exercise}

Let us interpret this expression. The fact
that $\E L \sim (1-\rho)^{-1}$ for $\rho\to 1$ implies that the
average waiting time increases very fast when $\rho\to1$.  If we want to avoid  long waiting times, this formula tells us that  situations with
$\rho\approx 1$ should be avoided. As a practical guideline, it is typically best to  keep $\rho$ quite a bit below 1, and accept that servers are not fully  utilized. 


\begin{exercise}
  Show that the excess probability $\P{L\geq n}$, i.e., the probability that a long queue occurs, is 
\begin{equation}\label{eq:pn}
  \P{L\geq n} = \rho^n.
\end{equation}
  \begin{hint}
$\P{L\geq n} = \sum_{k\geq n} p(k)$.
  \end{hint}
  \begin{solution}
    \begin{equation*}
      \begin{split}
 \P{L\geq n} 
 &= \sum_{k=n}^\infty p(k) = \sum_{k=n}^\infty p(0)\rho^k = (1-\rho)\sum_{k=n}^\infty \rho^k \\
 &= (1-\rho)\rho^n \sum_{k=0}^\infty\rho^k = (1-\rho) \rho^n \frac1{1-\rho}.
\end{split}
\end{equation*}
\end{solution}
\end{exercise}

Clearly,  the probability that the queue length exceeds some threshold decreases geometrically fast (for  $\rho<1$). If we make the simple assumption
that customers decide to leave (or rather, not join) the system when
the queue is longer than $9$ say, then $\P{L\geq 10} = \rho^{10}$ is
an estimator of the fraction of customers lost. 

% In the context of inventory theory these equations are particularly
% useful, see one of the questions below.

\begin{exercise}

Customers of fast-food restaurants prefer to be served from stock. For this reason such
restaurants often use a `produce-up-to' policy: When the on-hand inventory $I$ is equal or lower than some threshold $r$, the company produces items until the inventory level equals $r+1$ again. The level $r$ is the known as the reorder level.

Suppose that customers arrive as a Poisson process with rate $\lambda$
and the production times of single items are i.i.d. and exponentially
distributed with parameter $\mu$. Assume also that customers who
cannot be served from on-hand stock are backlogged, that is, they wait
until their item has been produced. What are the average on-hand
inventory level and the average number of customer in backlog?

\begin{hint}
  Realize that the inventory level $I(t)$ at time $t$ can be
  modeled as $I(t) = r+1-L(t)$, where $L$ is the number of jobs in an
  $M/M/1$ queue.
\end{hint}

  \begin{solution}
Average on-hand: $\E{I} = \sum_{i=0}^{r+1} (r+1-i) p(i)$. Average number of customers in backlog: $\E B = \sum_{i=r+1}^\infty (i-r-1) p(i)$. 
  \end{solution}
\end{exercise}

\subsection*{Supermarket Planning}

Let us consider the example of cashier planning of a supermarket to
demonstrate how to use the tools we developed up to now. Out of
necessity, our approach is a bit heavy-handed---Turning the example
into a practically useful scheme requires more sophisticated queueing
models and data assembly---but the present example contains the
essential analytic steps to solve the planning problem.

The \emph{service objective} is to determine the minimal service
capacity such that the fraction of the time more than 
10 people in queue is less than 1\%. (If the supermarket has 3 cashiers open, 10 people in queue  means about 3 people per queue.)

The next step is to find the \emph{relevant data}: the arrival rate and service time distribution. For a supermarket this is relatively easy: the cash registers track all customers
payments. Thus, we know the number of customers that left the shop,
hence entered the shop. (We neglect the time customers spend in the
shop.) Based on these data we can make a \emph{demand profile}: the
customer arrival rate per hour, c.f. Figure~\ref{fig:loadprofile}. It
is also easy to find the service distribution from the cash
registers. The first item scanned after a payment determines the start
of a new service, and the payment closes the service. (As there is
always a bit of time between the payment and the start of a new
service we might add 15 seconds, say, to any service.)

\begin{figure}[t]
  \centering
\begin{tikzpicture}[scale=.7]
 	%axis
	\draw[->] (0,0) -- coordinate (x axis mid) (13.5,0);
    	\draw[->] (0,0) -- coordinate (y axis mid) (0,5.5);
    	%ticks
    	\foreach \x in {0,...,13}
        \pgfmathsetmacro{\my}{int(\x+8)}
     		\draw (\x,1pt) -- (\x,-3pt)
			node[anchor=north] {$\my$};
    	\foreach \y in {0,...,5}
        \pgfmathsetmacro{\my}{int(\y*40)}
     		\draw (1pt,\y) -- (-3pt,\y) 
     			node[anchor=east] {\my}; 
%labels      
\node[below=0.6cm] at (x axis mid) {hour};
\node[rotate=90, left=1.2cm] at (y axis mid) {$\lambda$};

\draw (0,1)--(1,1);
\draw (1,2)--(2,2);
\draw (2,2.6)--(3,2.6);
\draw (3,2.8)--(4,2.8);
\draw (4,3.)--(5,3.);
\draw (5,3.1)--(6,3.1);
\draw (6,2.7)--(7,2.7);
\draw (7,1.9)--(8,1.9);
\draw (8,2.5)--(9,2.5);
\draw (9,3.3)--(10,3.3);
\draw (10,3.5)--(11,3.5);
\draw (11,2.3)--(12,2.3);
\draw (12,1.2)--(13,1.2);
\end{tikzpicture}
  \caption{A  demand profile of the arrival rate $\lambda$ modeled as constant over each hour.}
  \label{fig:loadprofile}
\end{figure}

To keep things simple, we model the arrival process as Poisson with an
arrival rate that is constant during an hour and is specified by the
demand profile, and we take the service time distribution as
exponential with a mean of $1.5$ minutes. We also \emph{model} the
behavior of all the cashiers together (a multi-server queue) as a single fast server. Thus, we neglect any differences between a station with, for instance, 3 cashiers and a
single server that works 3 times as fast as a normal cashier.  As yet
another simplification, we change the objective somewhat such that the
number of jobs in the queueing system should not exceed 10. (Thus, the
objective is no longer formulated in terms of queue lengths.)

The required number of servers per hour  follows from the
objective $1\% \geq \P{L>10}=\rho^{11}$. This  translates into $\rho \leq 0.67$. Using that $\rho = \lambda \E S/c$ and our estimate $\E{S}=1.5$ minutes,  we get  the following rough bound on $c$:
\begin{equation*}
c \geq \frac{\lambda \E S}{0.67} \approx \frac{3}2 \cdot \lambda \cdot 1.5  \approx 2.5 \lambda,
\end{equation*}
where $\lambda$ is the arrival rate (per minute, \emph{not} per hour).
For instance, for the hour from 12 to 13, we read in  the demand profile that $\lambda= 120$ customers per hour, hence $c=2.5 \cdot 120/60 = 5$. Thus, the conversion of the demand profile to a \emph{load} profile, which tells us the minimal number of cashiers needed
per hour, is trivial: divide the hourly arrival rate by $60$ and multiply by
2.5. 


Now we need to \emph{cover the load profile with service shifts}. This
is typically not easy since shifts have to satisfy all kinds of rules,
such as: after 2 hours of work a cashier should take a break of at least
10 minutes; a shift length must be at least four hours, and not longer
than 9 hours including breaks; when the shift is longer than 4 hours
it needs to contain at least one break of 30 minutes; and so on. These
shifts also have different costs: shifts with hours after 18h
are more expensive per hour; when the supermarket covers traveling
costs, short shifts have higher marginal traveling costs; and so on.

The usual way to solve such  covering problems is by means of an integer
problem. First generate all (or a subset of the) allowed shift types
with associated starting times. For instance, suppose only 4 shift
plans are available
\begin{enumerate}
\item $++-++$
\item $+++-+$
\item $++-+++$
\item $+++-++$,
\end{enumerate}
where a $+$ indicate a working hour and $-$ a break of an hour. Then
generate shift types for each of these plans with starting times
$8$am, $9$am, and on on, until the end of the day. Thus, a shift type
is a shift plan that starts at a certain hour. Let $x_i$ be the number
of shift type $i$ and $c_i$ the cost of this type. Write $t\in s_i$ if
hour $t$ is covered by shift type $i$.  Then the problem is to solve
\begin{equation*}
  \min \sum_i c_i x_i.
\end{equation*}
such that 
\begin{equation*}
  \sum_i x_i \1{t \in s_i} \geq \frac{\lambda_t}{20}
\end{equation*}
for all hours $t$ the shop is open and $\lambda_t$ is the demand for
hour $t$.



\Closesolutionfile{hint}
\Closesolutionfile{ans}
\subsection*{Hints}
\input{hint}
\subsection*{Solutions}
\input{ans}
\clearpage

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "book"
%%% End:
