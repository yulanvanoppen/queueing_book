%\section{Service Interruptions}
\section{Preemptive Interruptions, Server Failures}
\label{sec:preempt-interr-serv}

\subsection*{Theory and Exercises}

\Opensolutionfile{hint}
\Opensolutionfile{ans}

%See section 1.11 of Zijm's book for the theory.

In Sections~\ref{sec:setups-batch-proc} and \ref{sec:non-preempt-interr} we assumed that servers are never interrupted while serving a job.
However, in many situations this assumption is not satisfied: a person might receive a short phone call while working on a job, a machine may fail in the midst of processing, and so on.
In this section we develop a model to compute the influence on the mean waiting time of such \emph{preemptive outages}, i.e., interruptions that occur \emph{during} a service. 

Let us assume that a job's normal service time, without interruptions, is given by $S_0$. The durations of the interruptions are given by the i.i.d. random variables $\{R_i\}$ and have common mean $\E R$ and variance $\V R$. If $N$ interruptions occur, the effective service time will then be
\begin{equation*}
S= S_0 + \sum_{n=1}^N R_i.
\end{equation*}
Observe that to use the $G/G/1$ waiting time formula it suffices to find expressions for $\E S$ and $\V S$.
Thus, this will be our task for the rest of the section.
We remark in passing that the results and the derivation are of general interest.

We first aim to find an expression for $\E S$.  Write  $S_N = \sum_{i=1}^N R_i$ for the total duration of the interruptions, so that the total job duration becomes $S = S_0 + S_N$.

\begin{exercise}[\faFlask]
  Suppose that $N=n$, show that $\E{S_n}=n\E R$.
\begin{hint}
    Is it relevant that for the expectation of $S_n$ that $R_1,\ldots, R_n$ are mutually independent?
  \end{hint}
\begin{solution}
The expectation of the sum of random variables is the same as the sum of the expectations; independence is irrelevant. Hence,
\begin{equation*}
  \E{S_n } =  \E{\sum_{i=1}^n R_i}=  n \E R, 
\end{equation*}
since by assumption $\E{R_1} = \cdots = \E{R_n}$. 
\end{solution}
\end{exercise}

Let $p_n=\P{N=n}$; then it is reasonable that $\E{S_N}=\sum_{n=0}^\infty \E{S_n}p_n$. (Compare the definition of $\E{f(X)}=\sum_{n} f(n) p_n$.)

\begin{exercise}[\faCalculator]\label{ex:16}
Use the above to show that $\E{S_N}=\E R \E N$. (This result is known as \recall{Wald's equation}.)
\begin{hint}
  Use~\eqref{eq:77}. 
\end{hint}
\begin{solution}
Since $\E{S_n} = n \E R$, 
\begin{align*}
  \E{\sum_{i=1}^N R_i} 
&=  \E{ \sum_{n=0}^\infty \1{N=n} \left(\sum_{i=1}^n R_i \right)} \\
&=  \sum_{n=0}^\infty \E{\1{N=n} n\E{R}} \\
&=  \E{R} \sum_{n=0}^\infty n \E{\1{N=n}} = \E R \sum_{n=0}^\infty n p_n\\
&= \E R \E N.
\end{align*}
\end{solution}
\end{exercise}

Thus, with the above, 
\begin{equation*}
  \E{S} = \E{S_0 + S_N} = \E{S_0} + \E R \E N.
\end{equation*}
To make further progress, we need some additional assumptions.
A common assumption is that the time between two interruptions is $\Exp(\lambda_f)$, hence is memoryless.
Consequently, the number of interruptions $N$ that occur during the net service time $S_0$ is  Poisson distributed with mean $\E N = \lambda_f \E{S_0}$.


Define the \emph{availability} as
\begin{equation*}
  A=\frac{m_f}{m_f + m_r},
\end{equation*}
where $m_f$ is the mean time to fail and $m_r$ the mean time to repair. 
\begin{exercise}[\faFlask]
  Show that  for our model of interruptions,
  \begin{equation*}
A=\frac 1{1+\lambda_f \E R}
  \end{equation*}
  \begin{hint}
    Observe that $m_f = 1/\lambda_f$ and $m_r = \E R$.
  \end{hint}
  \begin{solution}
The time to fail is the time in between two interruptions. We assume that these times are $\Exp(1/\lambda_f)$. The duration of an interruption is $R$, which can be interpreted as the time to repair the server, hence $m_r = \E R$. With this
\begin{equation*}
  A=\frac{m_f}{m_r + m_f}=\frac{1/\lambda_f }{1/\lambda_f + \E R}. 
\end{equation*}
  \end{solution}
\end{exercise}


\begin{exercise}[\faFlask]
  Show that 
  \begin{equation*}
\E{S} = \frac{\E{S_0}} A = \E{S_0} (1+\lambda_f \E R).
  \end{equation*}
  \begin{hint}
    Realize that $\E N = \lambda_f \E{S_0}$.
  \end{hint}
  \begin{solution}
    \begin{equation*}
      \E S = \E{S_0} + \E N \E R = \E{S_0} +  \lambda_f \E{S_0} \E R= \E{S_0}(1+\lambda_f \E R).
    \end{equation*}
  \end{solution}
\end{exercise}
An intuitive way to obtain this result is by noting that $A$ is the fraction of time the server is working. As the total service time of a job is $\E S$, the net work done is $ A\E S$. But this must be the time needed to do the real job, hence $A \E S = \E{S_0}$.  

It is important to realize that 
\begin{equation*}
\rho = \lambda \E S = \lambda \frac{\E{S_0}}A,
\end{equation*}
hence the load increases due to failures. 


We can use similar ideas to derive an expression for the variance of $S$. The next exercise helps to  understand why this derivation is a bit more involved.
\begin{exercise}[\faFlask]
  Why is $\V{S} \neq \V{S_0} + \V{\sum_{i=0}^N R_i}$?
  \begin{solution}
    Observe that $S_0$ and $N$ are not independent. In fact, when $S_0=s$, the number of failures $N$ is Poisson distributed with mean $\lambda_f s$. 
  \end{solution}
\end{exercise}

So let us first consider $\E{S^2}$; recall that $\V S = \E{S^2} - (\E S)^2$, and we already know that $\E S = \E{S_0}/A$. 

\begin{exercise}[\faFlask]
Show that 
\begin{equation*}
  \E{S^2} = \E{S_0^2} + 2\E{S_0 \sum_{i=1}^N R_i} + \E{\sum_{i=1}^N R_i^2} + \E{\sum_{i=1}^N \sum_{j\neq i} R_i R_j}.
\end{equation*}
\begin{solution}
  Just work out the square of $S_0+\sum_{i=1}^N R_i$ and take expectations. Realize that $(\sum_i R_i)^2 = \sum_i R_i^2 + \sum_i\sum_{j\neq i} R_i R_j$.  
\end{solution}
\end{exercise}

To simplify this, we assume at first that $S_0$ is known, so that the number of failures that occur during a service time $S_0$ is Poisson distributed, i.e., $N\sim P(\lambda_f S_0)$.

\begin{exercise}[\faFlask]
  Show that $\E{S_0 \sum_{i=1}^N R_i\given S_0} = \lambda_f S_0^2 \E{R}$.
\begin{solution}
$\E{S_0 \sum_{i=1}^N R_i\given S_0} = 
S_0 \E{\sum_{i=1}^N R_i\given S_0} = S_0 \E R \E N = \lambda_f \E R S_0^2$.
\end{solution}
\end{exercise}

\begin{exercise}[\faFlask]
Show that $\E{\sum_{i=1}^N R_i^2\given S_0} = \lambda_f S_0 \E{R^2}$.
\begin{hint}
  Use Wald's equation, which we derived in Exercise~\ref{ex:16}.
\end{hint}
\begin{solution}
  \begin{align*}
    \E{\sum_{i=1}^N R_i^2\given S_0} 
&= \E{R^2}\E{ \sum_{n=0}^\infty n \1{N=n}\given S_0}\\
&= \E{R^2} \E{N\given S_0} \\
&= \lambda_f S_0 \E{R^2}.
  \end{align*}
\end{solution}
\end{exercise}

\begin{exercise}[\faCalculator]
Show that 
$\E{\sum_{i=1}^N \sum_{j\neq i} R_i R_j\given S_0} = \lambda_f^2 S_0^2 (\E{R})^2.$
\begin{solution}
Since the $\{R_i\}$ are i.i.d., 
  \begin{equation*}
\E{\sum_{i=1}^N \sum_{j\neq i} R_i R_j\given S_0}
= \E{N(N-1)|S_0} (\E{R})^2 
= (\E{N^2|S_0}-\E{N\given S_0}) (\E{R})^2.
  \end{equation*}
Now $\E{N^2\given S_0}=\lambda_f^2 S_0^2 +\lambda_f S_0$ and $\E{N\given S_0} = \lambda_f S_0$.
\end{solution}
\end{exercise}

\begin{exercise}[\faCalculator]
  Combine the above to see that
    $\E{S^2\given S_0} = \frac{S_0^2}{A^2} + \lambda_f \E{R^2} S_0$. From this, 
  \begin{equation*}
    \E{S^2} = \frac{\E{S_0^2}}{A^2} + \lambda_f \E{R^2} \E{S_0}.
  \end{equation*}
  \begin{solution}
For the first equation,
\begin{equation*}
  \E{S^2\given S_0} = S_0^2 + 2\lambda_f \E R S_0^2 + \lambda_f \E{R^2} S_0 + \lambda_f^2 (\E R)^2 S_0^2.
\end{equation*}
Assemble all terms with $S_0^2$ and observe that $(1/A) = 1+\lambda_f \E R$. For the second, recall that we assumed at first that $S_0$ was fixed, which we indicated by the condition on $S_0$. When $S_0$ is a random variable, we can just take the expectation at the left and right, and obtain the second result. 
  \end{solution}
\end{exercise}

\begin{exercise}[\faFlask]
Next, show that  
  \begin{equation*}
    \V{S} = \frac{\V{S_0}}{A^2} + \lambda_f \E{R^2} \E{S_0}.
  \end{equation*}
  \begin{solution}
    \begin{equation*}
    \V{S} = \E{S^2} - (\E S)^2 = 
\frac{\E{S_0^2}}{A^2} + \lambda_f \E{R^2} \E{S_0} -\frac{(\E{S_0})^2}{A^2}.
    \end{equation*}
  \end{solution}
\end{exercise}

\begin{exercise}[\faCalculator]
  Finally, show that
  \begin{equation*}
    C_s^2 = \frac{\V{S}}{(\E S)^2} = C_0^2 + \frac{\lambda_f \E{R^2} A^2}{\E{S_0}},
  \end{equation*}
where $C_0^2$ is the SCV of $S_0$, i.e., the service time without interruptions. 
\begin{hint} Just realize that $\E{S} = \E{S_0}/A$, and use the above.
\end{hint}
\begin{solution}
  \begin{align*}
C_s^2 &= \frac{\V{S}}{(\E S)^2} =\frac{V(S) A^2}{(\E{S_0})^2} \\
&=\frac{\E{S_0^2} + \lambda_f \E{R^2} \E{S_0}A^2 -(\E{S_0})^2}{(\E{S_0})^2} \\
&=\frac{\E{S_0^2} -(\E{S_0})^2}{(\E{S_0})^2} + \frac{\lambda_f \E{R^2} \E{S_0}A^2}{(\E{S_0})^2} \\
&=C_0^2 + \frac{\lambda_f \E{R^2}A^2}{\E{S_0}}.
  \end{align*}
\end{solution}
\end{exercise}

If we assume that repair times are exponentially distributed with mean $\E{R}$, we can simplify this yet further.

\begin{exercise}[\faCalculator]
With the above assumption on the distribution of $R$, show that
  \begin{equation*}
    C_s^2 = C_0^2 + 2 A(1-A) \frac{\E{R}}{\E{S_0}}.
  \end{equation*}
\begin{solution} 
When repair times are exponentially distributed with mean $\E{R}$:  $\E{R^2}=2(\E R)^2$. 

Since $A=1/(1+\lambda_f \E R)$, 
  \begin{equation*}
    \begin{split}
    \lambda_f \E{R^2} A^2 
&= 2\lambda_f (\E R)^2 A^2 = 2 \lambda_f \E R A A \E R \\
&= 2 \frac{\lambda_f \E R }{1+\lambda_f \E R} A \E R \\
&= 2 \left(1-\frac{1}{1+\lambda_f \E R}\right) A \E R  = 2(1-A)A \E R.
    \end{split}
  \end{equation*}
\end{solution}
\end{exercise}

Again, we have all elements ready to use the $G/G/1$ waiting time formula. Let's illustrate this. 

\begin{exercise}[\faPhoto]
  Suppose we have a machine with memoryless failure behavior, with a mean-time-to-fail of $3$ hours. Regular service times are deterministic with an average of 10 minutes, jobs arrive as a Poisson process with rate of 4 per hour.  Repair times are exponential with a mean duration of 30 minutes. What is the average sojourn time?
  \begin{hint}
    Mind to work in a consistent set of units, e.g., hours. It is easy to make mistakes. 
  \end{hint}
  \begin{solution}
Let's first compute the load. If $\rho>1$ we are in trouble.
    \begin{pyconsole}
labda = 4.
ES0 = 10./60 # in hours
labda_f = 1./3
ER = 30./60 # in hours
A = 1./(1+labda_f*ER)
A
ES = ES0/A
ES
rho = labda*ES
rho
    \end{pyconsole}
As $\rho<1$, the system is not in overload. Now for the queueing time.
\begin{pyconsole}
Ca2 = 1.
C02 = 0. # deterministic service times
Ce2 = C02 + 2*A*(1-A)*ER/ES0
Ce2
EW = (Ca2+Ce2)/2 * rho/(1-rho) * ES
EW
EW + ES # sojourn time
\end{pyconsole}
  \end{solution}
\end{exercise}

\begin{exercise}[\faPhoto]
  Suppose we could buy another machine that never fails. What is the average sojourn time?
  \begin{solution}
Now we don't need to take availability into account: the machine never fails so $A=1$. 
    \begin{pyconsole}
labda = 4.
ES0 = 10./60 # in hours
A = 1
ES = ES0/A
rho = labda*ES
rho
Ca2 = 1.
C02 = 0. # deterministic service times
EW = (Ca2+C02)/2 * rho/(1.-rho) * ES
EW
EW + ES # sojourn time
\end{pyconsole}
The average time in queue reduces from $\approx 0.6$ to $\approx 0.17$ hours, a reduction by about a factor 3. 
\end{solution}
\end{exercise}


\Closesolutionfile{hint}
\Closesolutionfile{ans}

\opt{solutionfiles}{
\subsection*{Hints}
\input{hint}
\subsection*{Solutions}
\input{ans}
}


%\clearpage


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../queueing_book"
%%% End:
